import { MigrationInterface, QueryRunner } from "typeorm";

export class WatchStatsMaterializedView1719971499108 implements MigrationInterface {
    name = 'WatchStatsMaterializedView1719971499108'

    public async up(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query(`CREATE MATERIALIZED VIEW "watch_stat" AS WITH "ordered_events" AS (SELECT video_event."userId" AS "user_id", video_event."unitSlug" AS "unit_slug", video_event."itemId" AS "item_id", video_event."type" AS "type", video_event."timestamp" AS "timestamp", (video_event."eventData"->>'loaded')::NUMERIC AS "loaded_pct", (video_event."eventData"->>'loadedSeconds')::NUMERIC AS "loaded_seconds", (video_event."eventData"->>'playedSeconds')::NUMERIC AS "played_seconds", LAG((video_event."eventData"->>'playedSeconds')::NUMERIC) OVER (PARTITION BY video_event."userId", video_event."itemId" ORDER BY (video_event."eventData"->>'playedSeconds')::NUMERIC) AS "lag_played_seconds", MAX((video_event."eventData"->>'playedSeconds')::NUMERIC) OVER (PARTITION BY video_event."userId", video_event."itemId" ORDER BY (video_event."eventData"->>'playedSeconds')::NUMERIC) AS "max_played_seconds" FROM "video_event" "video_event" ORDER BY played_seconds ASC), "rolling_sums" AS (SELECT user_id, unit_slug, item_id, type, timestamp, loaded_seconds, played_seconds, 
            SUM(
              CASE
              WHEN played_seconds >= max_played_seconds AND ABS(played_seconds - lag_played_seconds) < 6 THEN played_seconds - lag_played_seconds
              ELSE 0
                END
            ) OVER (
              PARTITION BY user_id, item_id
              ORDER BY played_seconds
              ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
            )
             AS "rolling_sum_seconds_watched" FROM "ordered_events" "ordered_events"), "video_duration" AS (SELECT item_id, MAX(loaded_seconds / loaded_pct) AS "duration" FROM "ordered_events" "ordered_events" WHERE loaded_pct > 0 GROUP BY item_id), "user_video_progress" AS (SELECT user_id, unit_slug, item_id, MAX(rolling_sum_seconds_watched) AS "total_played_seconds" FROM "rolling_sums" "rolling_sums" GROUP BY user_id, item_id, unit_slug) SELECT "organization"."id" AS "organizationId", "organization"."slug" AS "organizationSlug", "organization"."name" AS "organizationName", "unit"."id" AS "unitId", "unit"."slug" AS "unitSlug", "unit"."name" AS "unitName", training_item."id" AS "trainingItemId", training_item."metadataTitle" AS "trainingItemTitle", ROUND(100.0 * user_video_progress.total_played_seconds / video_duration.duration, 2) AS "percentWatched", user_representation."id" AS "userId", user_representation."externalId" AS "userExternalId", user_representation."givenName" AS "firstName", user_representation."familyName" AS "lastName", user_representation."email" AS "email" FROM "user_video_progress" "user_video_progress" LEFT JOIN "training_item" "training_item" ON user_video_progress.item_id = training_item.id::TEXT  LEFT JOIN "video_duration" "video_duration" ON video_duration.item_id = training_item.id::TEXT  LEFT JOIN "user_representation" "user_representation" ON user_representation."externalId" = user_video_progress.user_id  LEFT JOIN "organization" "organization" ON "organization"."slug" = user_representation."organizationSlug"  LEFT JOIN "unit" "unit" ON "unit"."slug" = user_representation."unitSlug"`);
        await queryRunner.query(`INSERT INTO "typeorm_metadata"("database", "schema", "table", "type", "name", "value") VALUES (DEFAULT, $1, DEFAULT, $2, $3, $4)`, ["public","MATERIALIZED_VIEW","watch_stat","WITH \"ordered_events\" AS (SELECT video_event.\"userId\" AS \"user_id\", video_event.\"unitSlug\" AS \"unit_slug\", video_event.\"itemId\" AS \"item_id\", video_event.\"type\" AS \"type\", video_event.\"timestamp\" AS \"timestamp\", (video_event.\"eventData\"->>'loaded')::NUMERIC AS \"loaded_pct\", (video_event.\"eventData\"->>'loadedSeconds')::NUMERIC AS \"loaded_seconds\", (video_event.\"eventData\"->>'playedSeconds')::NUMERIC AS \"played_seconds\", LAG((video_event.\"eventData\"->>'playedSeconds')::NUMERIC) OVER (PARTITION BY video_event.\"userId\", video_event.\"itemId\" ORDER BY (video_event.\"eventData\"->>'playedSeconds')::NUMERIC) AS \"lag_played_seconds\", MAX((video_event.\"eventData\"->>'playedSeconds')::NUMERIC) OVER (PARTITION BY video_event.\"userId\", video_event.\"itemId\" ORDER BY (video_event.\"eventData\"->>'playedSeconds')::NUMERIC) AS \"max_played_seconds\" FROM \"video_event\" \"video_event\" ORDER BY played_seconds ASC), \"rolling_sums\" AS (SELECT user_id, unit_slug, item_id, type, timestamp, loaded_seconds, played_seconds, \n            SUM(\n              CASE\n              WHEN played_seconds >= max_played_seconds AND ABS(played_seconds - lag_played_seconds) < 6 THEN played_seconds - lag_played_seconds\n              ELSE 0\n                END\n            ) OVER (\n              PARTITION BY user_id, item_id\n              ORDER BY played_seconds\n              ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW\n            )\n             AS \"rolling_sum_seconds_watched\" FROM \"ordered_events\" \"ordered_events\"), \"video_duration\" AS (SELECT item_id, MAX(loaded_seconds / loaded_pct) AS \"duration\" FROM \"ordered_events\" \"ordered_events\" WHERE loaded_pct > 0 GROUP BY item_id), \"user_video_progress\" AS (SELECT user_id, unit_slug, item_id, MAX(rolling_sum_seconds_watched) AS \"total_played_seconds\" FROM \"rolling_sums\" \"rolling_sums\" GROUP BY user_id, item_id, unit_slug) SELECT \"organization\".\"id\" AS \"organizationId\", \"organization\".\"slug\" AS \"organizationSlug\", \"organization\".\"name\" AS \"organizationName\", \"unit\".\"id\" AS \"unitId\", \"unit\".\"slug\" AS \"unitSlug\", \"unit\".\"name\" AS \"unitName\", training_item.\"id\" AS \"trainingItemId\", training_item.\"metadataTitle\" AS \"trainingItemTitle\", ROUND(100.0 * user_video_progress.total_played_seconds / video_duration.duration, 2) AS \"percentWatched\", user_representation.\"id\" AS \"userId\", user_representation.\"externalId\" AS \"userExternalId\", user_representation.\"givenName\" AS \"firstName\", user_representation.\"familyName\" AS \"lastName\", user_representation.\"email\" AS \"email\" FROM \"user_video_progress\" \"user_video_progress\" LEFT JOIN \"training_item\" \"training_item\" ON user_video_progress.item_id = training_item.id::TEXT  LEFT JOIN \"video_duration\" \"video_duration\" ON video_duration.item_id = training_item.id::TEXT  LEFT JOIN \"user_representation\" \"user_representation\" ON user_representation.\"externalId\" = user_video_progress.user_id  LEFT JOIN \"organization\" \"organization\" ON \"organization\".\"slug\" = user_representation.\"organizationSlug\"  LEFT JOIN \"unit\" \"unit\" ON \"unit\".\"slug\" = user_representation.\"unitSlug\""]);
        await queryRunner.query(`CREATE INDEX "watch_stat_user_id_idx" ON "watch_stat" ("userId") `);
        await queryRunner.query(`CREATE INDEX "watch_stat_user_external_id_idx" ON "watch_stat" ("userExternalId") `);
        await queryRunner.query(`CREATE INDEX "watch_stat_email_idx" ON "watch_stat" ("email") `);
        await queryRunner.query(`CREATE INDEX "IDX_0bf8fd8491f9780d49d22a92db" ON "watch_stat" ("organizationId", "unitId", "trainingItemId") `);
        await queryRunner.query(`CREATE INDEX "IDX_45cbc4f08594c2216f25d03d7a" ON "watch_stat" ("organizationSlug", "unitSlug", "trainingItemId") `);
    }

    public async down(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query(`DROP INDEX "public"."IDX_45cbc4f08594c2216f25d03d7a"`);
        await queryRunner.query(`DROP INDEX "public"."IDX_0bf8fd8491f9780d49d22a92db"`);
        await queryRunner.query(`DROP INDEX "public"."watch_stat_email_idx"`);
        await queryRunner.query(`DROP INDEX "public"."watch_stat_user_external_id_idx"`);
        await queryRunner.query(`DROP INDEX "public"."watch_stat_user_id_idx"`);
        await queryRunner.query(`DELETE FROM "typeorm_metadata" WHERE "type" = $1 AND "name" = $2 AND "schema" = $3`, ["MATERIALIZED_VIEW","watch_stat","public"]);
        await queryRunner.query(`DROP MATERIALIZED VIEW "watch_stat"`);
    }

}
